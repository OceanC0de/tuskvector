<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuskVector Lab</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
</head>
<body>
    <div class="container">
        <h1>TuskVector Lab üß™<span class="version">v0.1.1</span></h1>
        
        <div class="section">
            <h2>Welcome to the TuskVector Lab</h2>
            <p>
                This is where you can experiment with TuskVector's capabilities.
                Try out vector operations, test API endpoints, and explore our features.
            </p>
            <p>To start using the TuskVector API, you'll need an API key. Register below to get your key instantly!</p>
            <form hx-post="/api/generate_api_key" 
                  hx-target="#api-key-result" 
                  hx-swap="innerHTML">
                <input type="email" name="email" placeholder="Your Email" required>
                <button type="submit">Get New API Key</button>
            </form>
            <div id="api-key-result"></div>
            <div class="api-key-input" style="margin-top: 20px;">
                <label for="api-key">Use API Key:</label>
                <input type="text" id="api-key" placeholder="Or enter your existing API key here (if you request a new one, this field gets auto populated)">
            </div>
        </div>
        
        <div class="section">
            <h2>Add Facts</h2>
            <form hx-post="/api/embed_text" 
                  hx-ext="json-enc"
                  hx-target="#embed-result" 
                  hx-swap="innerHTML"
                  hx-headers='js:{
                      "X-API-Key": document.getElementById("api-key").value
                  }'
                  hx-indicator="#embed-loader">
                <input type="text" name="text" placeholder="Make LLM Smarter" required>
                <button type="submit">Embed Text</button>
                <div id="embed-loader" class="htmx-indicator">Loading...</div>
            </form>
            <div id="embed-result"></div>
        </div>

        <div class="section">
            <h2>Query LLM</h2>
            <form hx-post="/api/query" 
                  hx-ext="json-enc"
                  hx-target="#query-result" 
                  hx-swap="innerHTML"
                  hx-headers='js:{
                      "X-API-Key": document.getElementById("api-key").value
                  }'
                  hx-indicator="#query-loader">
                <input type="text" name="text" placeholder="Ask LLM" required>
                <button type="submit">Ask Question</button>
                <div id="query-loader" class="htmx-indicator">Loading...</div>
            </form>
            <div id="query-result"></div>
        </div>

        <div class="section">
            <h2>Return to the TuskVector Start Page üêò</h2>
            <p>
                Thank you for exploring the TuskVector Lab Area. Ready to learn more about our services or integrate TuskVector into your projects?
                Head back to our home page for comprehensive information and resources.
            </p>
            <a href="/" class="docs-link">Back to Home üè†</a>
        </div>
    </div>

    <!-- Hidden elements for JSON parsing -->
    <div id="json-response" hx-swap-oob="true">
        <span id="embed-id" hx-swap-oob="true" hx-swap="innerHTML"></span>
        <span id="query-response" hx-swap-oob="true" hx-swap="innerHTML"></span>
    </div>

    <script>
        htmx.on("htmx:responseError", function(event) {
            var targetId = event.detail.target.id;
            var errorMessage = event.detail.xhr.response;
            var errorDiv = document.getElementById(targetId);
            errorDiv.innerHTML = '<p class="error-message">' + errorMessage + '</p>';
        });

        // New script to handle API key generation and input
        htmx.on("htmx:afterSettle", function(event) {
            if (event.detail.target.id === "api-key-result") {
                var apiKeySpan = event.detail.target.querySelector(".api-key");
                if (apiKeySpan) {
                    var apiKey = apiKeySpan.textContent;
                    document.getElementById("api-key").value = apiKey;
                }
            }
        });
    </script>
</body>
</html>